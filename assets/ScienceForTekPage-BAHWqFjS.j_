import{Q as le}from"./QPage-DAomX7La.js";import{Q as ie}from"./QSpinnerDots-B_-BC47s.js";import{Q as re}from"./QBanner-Bh0a8mRE.js";import{Q as ce}from"./QSeparator-BwTGVoGv.js";import{Q as z,a as E}from"./QItem-DIgVajpF.js";import{Q as H}from"./QList-Bzp8q5wm.js";import{a6 as W,z as Q,a7 as k,a8 as d,a9 as l,ab as c,ap as t,ae as h,aq as S,ax as L,ar as J,H as $,am as ue,aA as de,Y as pe,J as me,aa as A,ak as g,ad as N,aB as fe,af as V,aW as ve}from"./index-Bhl6SETv.js";import{c as v,R as he,A as ge,a as _e,T as xe,p as P}from"./ResponsiveTheme-Ck20dRLL.js";import{u as we,M as be,g as ye,a as Se}from"./useGeoJson-DGaBucA4.js";import{u as ke}from"./useScienceForTek-DQNyZiNp.js";import{a as Te,b as Ce,c as De,u as Qe}from"./useMapContainerSize-BlGOuocN.js";import{Q as R}from"./QCardSection-CIRpBG4M.js";import{Q as Y}from"./QCard-4hNWPW3w.js";import{Q as qe}from"./QExpansionItem-DbF2WVJd.js";import{_ as X}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{L as Me}from"./Legend-B80d664G.js";import"./use-dark-CCCGl-by.js";import"./use-id-CTOrvLVL.js";import"./uid-Bzmka5Fh.js";import"./use-model-toggle-DypRWqPB.js";const Fe={class:"stats rea-border-blue q-pa-sm text-center"},Ae={class:"text-h6 text-primary"},Pe={class:"stats rea-border-blue q-pa-sm text-center"},$e={class:"text-h6 text-primary"},Ie={class:"row items-center justify-between full-width"},Le={class:"col-7"},ze={class:"col-2 text-right text-bold"},Ee={class:"col-3 text-right text-bold"},Be=W({__name:"MapScienceForTekStatsWidget",props:{mapData:{}},setup(q){const u=q,a=Q(()=>u.mapData.reduce((n,i)=>n+i.name_count,0)),T=Q(()=>u.mapData.reduce((n,i)=>n+i.executor_count,0)),f=Q(()=>{const n=new Map;return u.mapData.forEach(i=>{i.industries&&i.industries.forEach(r=>{if(n.has(r.name)){const p=n.get(r.name);p.name_count+=r.name_count,p.executor_count+=r.executor_count}else n.set(r.name,{name:r.name,name_count:r.name_count,executor_count:r.executor_count})})}),Array.from(n.values())});return(n,i)=>(d(),k(Y,{class:"map-stats-widget q-pa-sm"},{default:l(()=>[c(R,{class:"q-pa-xs flex q-gutter-xs justify-between"},{default:l(()=>[t("div",Fe,[i[0]||(i[0]=t("div",{class:"text-caption"},"НИОКТР",-1)),t("div",Ae,h(a.value),1)]),t("div",Pe,[i[1]||(i[1]=t("div",{class:"text-caption"},"Исполнителей",-1)),t("div",$e,h(T.value),1)])]),_:1}),c(R,{class:"q-pa-xs"},{default:l(()=>[c(qe,{caption:"Подробная статистика","expand-separator":"",label:"По отраслям"},{default:l(()=>[c(Y,null,{default:l(()=>[c(R,{class:"q-pa-xs"},{default:l(()=>[c(H,{separator:""},{default:l(()=>[c(z,{class:"q-pa-none",dense:""},{default:l(()=>[c(E,null,{default:l(()=>i[2]||(i[2]=[t("div",{class:"row items-center justify-between full-width"},[t("div",{class:"col-7 caption-small"},"Отрасль"),t("div",{class:"col-2 text-right caption-small"},"НИОКТР"),t("div",{class:"col-3 text-right caption-small"}," Исполнители ")],-1)])),_:1})]),_:1}),(d(!0),S(L,null,J(f.value,r=>(d(),k(z,{key:r.name,class:"q-pa-none",dense:""},{default:l(()=>[c(E,null,{default:l(()=>[t("div",Ie,[t("div",Le,h(r.name),1),t("div",ze,h(r.name_count),1),t("div",Ee,h(r.executor_count),1)])]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}))}}),Ne=X(Be,[["__scopeId","data-v-745b1c10"]]);function Re(q,u={}){const{offset:a=15,preferredPositions:T=["right-bottom","left-bottom","right-top","left-top"]}=u,{x:f,y:n}=Te(),{width:i,height:r}=Ce(),{width:p,height:_}=De(q),b=$(!1);return{position:Q(()=>{if(!b.value)return{x:0,y:0};const m={right:i.value-f.value-a,bottom:r.value-n.value-a,left:f.value-a,top:n.value-a},M=m.right>=p.value,C=m.bottom>=_.value,F=m.left>=p.value,D=m.top>=_.value;for(const w of T)switch(w){case"right-bottom":if(M&&C)return{x:f.value+a,y:n.value+a};break;case"left-bottom":if(F&&C)return{x:f.value-p.value-a,y:n.value+a};break;case"right-top":if(M&&D)return{x:f.value+a,y:n.value-_.value-a};break;case"left-top":if(F&&D)return{x:f.value-p.value-a,y:n.value-_.value-a};break}if(M||m.right>m.left){const w=C||m.bottom>m.top?n.value+a:n.value-_.value-a;return{x:f.value+a,y:w}}else{const w=C||m.bottom>m.top?n.value+a:n.value-_.value-a;return{x:f.value-p.value-a,y:w}}}),isVisible:b,show:()=>{b.value=!0},hide:()=>{b.value=!1}}}const We={key:1,class:"error-message absolute-center"},je={class:"text-center text-subtitle1 text-bold"},Ve={key:0,class:"q-pa-xs flex q-gutter-xs justify-between"},Ye={class:"text-caption q-mb-xs"},He={class:"text-bold"},Je={class:"text-caption q-mb-xs"},Xe={class:"text-bold"},Oe={key:1,class:"text-caption"},Ue={class:"row items-center justify-between full-width"},Ge={class:"col-7"},Ze={class:"col-2 text-right text-bold"},Ke={class:"col-3 text-right text-bold"},et=W({__name:"MapScienceForTek",setup(q){const u=$(null),a=$(null),{position:T,isVisible:f,show:n,hide:i}=Re(a),r=ue(),p=$(null),_=$(),b=de(),{fetchGeoJson:j,loading:B}=we({defaultQuality:"Q0",cacheResults:!0}),{mapData:x,loading:m,fetchMapData:M}=ke(),{containerStyles:C}=Qe({aspectRatio:16/9,maxHeight:"80vh",minHeight:"60vh"}),F={colorScale:[{value:0,color:v(14540253)},{value:1,color:v(11135222)},{value:5,color:v(3394815)},{value:15,color:v(39389)},{value:30,color:v(4554963)}],legend:[{name:"Высокая активность (30+)",color:v(4554963)},{name:"Выше среднего (15-29)",color:v(39389)},{name:"Средняя активность (5-14)",color:v(3394815)},{name:"Низкая активность (1-4)",color:v(11135222)},{name:"Нет данных",color:v(14540253)}]},D=Q(()=>F.colorScale||[]),w=Q(()=>D.value[0]?.color||v(14540253));function O(e){if(e===0||e===void 0||e===null)return w.value;for(let o=D.value.length-1;o>=0;o--){const s=D.value[o];if(s&&e>=s.value)return s.color||w.value}return w.value}function U(e){e.setThemes([ge.new(e),_e.new(e)]),e.numberFormatter.setAll({numberFormat:{style:"decimal",minimumFractionDigits:0,maximumFractionDigits:0},intlLocales:"ru-RU"}),e.timezone=xe.new("Europe/Moscow"),e.tapToActivate=!0,e.tapToActivateTimeout=2e3}function G(e){return e.container.children.push(be.new(e,{projection:ye(),rotationX:-100,rotationY:-20,panX:"none",panY:"none",wheelX:"none",wheelY:"none",homeZoomLevel:1,paddingTop:30,paddingBottom:60,paddingLeft:10,paddingRight:10,height:P(95)}))}function Z(e,o,s){return o.series.push(Se.new(e,{geoJSON:s}))}function K(){if(!x.value||!x.value.length)return console.error("No map data available for choropleth"),[];const e=[];for(const o of x.value)if(o&&o.region){const s=o.name_count!==void 0?o.name_count:0,y=O(s);e.push({id:o.region,polygonSettings:{fill:y}})}return e}function ee(e){e.set("tooltip",void 0),e.mapPolygons.template.events.on("pointerover",o=>{const y=o.target.dataItem?.dataContext;if(!y)return;const I=y.id,se=x.value?.find(ne=>ne.region===I);u.value={regionName:y.name||"Unknown Region",scienceData:se||void 0},n()}),e.mapPolygons.template.events.on("pointerout",()=>{i()}),e.mapPolygons.template.events.on("click",o=>{const s=o.target.dataItem;if(!s||!s.dataContext)return;const I=s.dataContext.id;I&&r.push({name:"region",params:{id:I}})})}function te(e){e.mapPolygons.template.setAll({fillOpacity:.8,stroke:v(3355443),strokeWidth:.5,fill:w.value,templateField:"polygonSettings",interactive:!0}),e.mapPolygons.template.states.create("hover",{fillOpacity:1}),ee(e),e.data.setAll(K())}function oe(e,o){const s=o.children.push(Me.new(e,{nameField:"name",fillField:"color",strokeField:"color",x:P(50),centerX:P(50),y:P(100),centerY:P(0)}));ae(s),s.data.setAll(F.legend)}function ae(e){e.markers.template.setAll({width:10,height:10}),e.labels.template.setAll({fontSize:"0.8rem",fontWeight:"300"}),e.itemContainers.template.setAll({paddingTop:0,paddingBottom:5})}return pe(async()=>{if(_.value)try{if(await M(),!x.value||!x.value.length)throw new Error("Не удалось загрузить данные науки для ТЭК");b.value=he.new(_.value);const{value:e}=b;if(!e)return;e._logo?.dispose(),U(e);const o=await j();if(!o)throw new Error("Не удалось загрузить гео-данные карты");const s=G(e),y=Z(e,s,o);te(y),oe(e,s),await s.appear(1e3,100)}catch(e){console.error("Map error:",e),p.value=e instanceof Error?e.message:"Неизвестная ошибка"}}),me(()=>{b.value?.dispose()}),(e,o)=>(d(),S(L,null,[t("div",{ref_key:"rootDiv",ref:_,style:V(g(C)),class:fe(["map-container",{loading:g(B)||g(m),error:p.value}])},[g(B)||g(m)?(d(),k(ie,{key:0,color:"primary",size:"xl",class:"absolute-center"})):A("",!0),p.value?(d(),S("div",We,[c(re,{"inline-actions":"",class:"text-white bg-red"},{default:l(()=>[N(h(p.value),1)]),_:1})])):A("",!0),g(x)&&g(x).length?(d(),k(Ne,{key:2,"map-data":g(x)},null,8,["map-data"])):A("",!0)],6),(d(),k(ve,{to:"body"},[g(f)&&u.value?(d(),S("div",{key:0,ref_key:"tooltipRef",ref:a,class:"map-tooltip",style:V({position:"absolute",left:`${g(T).x}px`,top:`${g(T).y}px`,zIndex:9999,pointerEvents:"none"})},[t("div",je,h(u.value.regionName),1),u.value.scienceData?(d(),S("div",Ve,[t("div",null,[t("div",Ye,[o[0]||(o[0]=N(" НИОКТР: ")),t("span",He,h(u.value.scienceData.name_count),1)])]),t("div",null,[t("div",Je,[o[1]||(o[1]=N(" Исполнителей: ")),t("span",Xe,h(u.value.scienceData.executor_count),1)])])])):(d(),S("div",Oe,"Нет данных для этого региона")),u.value.scienceData?.industries?.length?(d(),S(L,{key:2},[c(ce,{class:"q-my-xs"}),o[3]||(o[3]=t("div",{class:"text-subtitle2 q-my-sm"},"По отраслям",-1)),c(H,{separator:""},{default:l(()=>[c(z,{class:"q-pa-none",dense:""},{default:l(()=>[c(E,null,{default:l(()=>o[2]||(o[2]=[t("div",{class:"row items-center justify-between full-width"},[t("div",{class:"col-7 caption-small"},"Отрасль"),t("div",{class:"col-2 text-right caption-small"},"НИОКТР"),t("div",{class:"col-3 text-right caption-small"},"Исполнители")],-1)])),_:1})]),_:1}),(d(!0),S(L,null,J(u.value.scienceData.industries,s=>(d(),k(z,{key:s.name,class:"q-pa-none",dense:""},{default:l(()=>[c(E,null,{default:l(()=>[t("div",Ue,[t("div",Ge,h(s.name),1),t("div",Ze,h(s.name_count),1),t("div",Ke,h(s.executor_count),1)])]),_:2},1024)]),_:2},1024))),128))]),_:1})],64)):A("",!0)],4)):A("",!0)]))],64))}}),tt=X(et,[["__scopeId","data-v-ad176081"]]),ot={class:"row"},St=W({__name:"ScienceForTekPage",setup(q){return(u,a)=>(d(),k(le,{padding:""},{default:l(()=>[t("div",ot,[a[0]||(a[0]=t("div",{class:"col-12"},[t("div",{class:"header-glow text-primary text-h3 text-weight-light q-pr-xl"}," Научное сопровождение топливно-энергетического комплекса ")],-1)),c(tt)])]),_:1}))}});export{St as default};
